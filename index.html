<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTP Template Editor</title>
    <!-- CodeMirror 6 CSS is included in the modules -->
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-left">
                <h1>TTP Template Editor</h1>
            </div>
            <div class="header-controls">
                <!-- Main Actions -->
                <div class="main-actions">
                    <button id="processBtn" class="btn btn-primary">Process</button>
                    <button id="downloadBtn" class="btn btn-secondary">Download</button>
                    <select id="outputFormat" class="format-select">
                        <option value="json">JSON</option>
                        <option value="yaml">YAML</option>
                        <option value="table">Table</option>
                    </select>
                </div>

                <!-- Actions Dropdown -->
                <div class="dropdown">
                    <button class="dropdown-toggle" title="Actions">
                        ‚ö° Actions
                    </button>
                    <div class="dropdown-menu">
                        <button id="clearBtn" class="dropdown-item">üóëÔ∏è Clear All</button>
                        <button id="exampleBtn" class="dropdown-item">üìù Load Example</button>
                    </div>
                </div>

                <!-- Configuration Dropdown -->
                <div class="dropdown">
                    <button class="dropdown-toggle" title="Configuration">
                        ‚öôÔ∏è Config
                    </button>
                    <div class="dropdown-menu">
                        <button id="inputsBtn" class="dropdown-item">üì• Inputs</button>
                        <button id="globalVarsBtn" class="dropdown-item">Variables</button>
                        <button id="functionsBtn" class="dropdown-item">Functions</button>
                        <button id="lookupsBtn" class="dropdown-item">Lookups</button>
                        <button id="packagesBtn" class="dropdown-item">üì¶ Packages</button>
                    </div>
                </div>

                <!-- File Dropdown -->
                <div class="dropdown">
                    <button class="dropdown-toggle" title="File Operations">
                        üìÅ File
                    </button>
                    <div class="dropdown-menu">
                        <button id="exportBtn" class="dropdown-item">üíæ Export</button>
                        <button id="importBtn" class="dropdown-item">üìÇ Import</button>
                    </div>
                </div>

                <!-- Workspace Dropdown -->
                <div class="dropdown">
                    <button class="dropdown-toggle" title="Workspace Management">
                        üíæ Workspace
                    </button>
                    <div class="dropdown-menu">
                        <button id="saveWorkspaceBtn" class="dropdown-item">üíæ Save</button>
                        <button id="loadWorkspaceBtn" class="dropdown-item">üìÇ Load</button>
                        <button id="manageWorkspacesBtn" class="dropdown-item">üîß Manage</button>
                    </div>
                </div>

                <!-- Right Side -->
                <div class="header-right">
                    <a href="https://ttp.readthedocs.io/en/latest/" target="_blank" class="btn btn-icon" id="docsBtn" title="TTP Documentation (v3.8.4)">üìö</a>
                    <label class="auto-process-toggle">
                        <input type="checkbox" id="autoProcess" checked>
                        <span>Auto</span>
                    </label>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="pane-container">
                <!-- Data Input Pane -->
                <div class="pane data-pane">
                    <div class="panel-header">
                        <span class="panel-title">Input Data</span>
                    </div>
                    <div class="editor-wrapper">
                        <textarea id="dataInput" placeholder="Paste your raw text data here..."></textarea>
                    </div>
                </div>

                <!-- Resize Handle 1 -->
                <div class="resize-handle" data-direction="horizontal"></div>

                <!-- Template Input Pane -->
                <div class="pane template-pane">
                    <div class="panel-header">
                        <span class="panel-title">TTP Template</span>
                    </div>
                    <div class="editor-wrapper">
                        <textarea id="templateInput" placeholder="Enter your TTP template here..."></textarea>
                    </div>
                </div>

                <!-- Resize Handle 2 -->
                <div class="resize-handle" data-direction="horizontal"></div>

                <!-- Results Pane -->
                <div class="pane result-pane">
                    <div class="panel-header">
                        <span class="panel-title">Parsed Results</span>
                    </div>
                    <div class="result-wrapper">
                        <div id="resultOutput">Results will appear here after processing...</div>
                    </div>
                </div>
            </div>
        </main>

        <div class="status-bar">
            <div class="status-item">
                <span id="pyodideStatus">Loading Python runtime...</span>
            </div>
            <div class="status-item">
                <span id="processingTime"></span>
            </div>
        </div>
    </div>

    <!-- Global Variables Modal -->
    <div id="globalVarsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Variables</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="vars-format-selector">
                    <label for="varsFormat">Format:</label>
                    <select id="varsFormat" class="format-select">
                        <option value="json">JSON</option>
                        <option value="yaml">YAML</option>
                        <option value="python">Python Dict</option>
                    </select>
                </div>
                <div class="vars-editor-container">
                    <div id="varsEditor" class="vars-editor"></div>
                </div>
                <div class="modal-footer">
                    <button id="saveVarsBtn" class="btn btn-primary">Save Variables</button>
                    <button id="clearVarsBtn" class="btn btn-secondary">Clear</button>
                    <button id="cancelVarsBtn" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Functions Modal -->
    <div id="functionsModal" class="modal">
        <div class="modal-content functions-modal-content">
            <div class="modal-header">
                <h2>Custom Functions</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="functions-container" id="functionsContainer">
                    <!-- Function entries will be added here dynamically -->
                </div>
                <button id="addFunctionBtn" class="btn btn-secondary add-function-btn">+ Add Function</button>
                <div class="modal-footer">
                    <button id="saveFunctionsBtn" class="btn btn-primary">Save Functions</button>
                    <button id="clearFunctionsBtn" class="btn btn-secondary">Clear All</button>
                    <button id="cancelFunctionsBtn" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lookups Modal -->
    <div id="lookupsModal" class="modal">
        <div class="modal-content lookups-modal-content">
            <div class="modal-header">
                <h2>Lookup Tables</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="lookups-container" id="lookupsContainer">
                    <!-- Lookup entries will be added here dynamically -->
                </div>
                <button id="addLookupBtn" class="btn btn-secondary add-lookup-btn">+ Add Lookup</button>
                <div class="modal-footer">
                    <button id="saveLookupsBtn" class="btn btn-primary">Save Lookups</button>
                    <button id="clearLookupsBtn" class="btn btn-secondary">Clear All</button>
                    <button id="cancelLookupsBtn" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Initializing Python runtime...</p>
            <p class="loading-detail">This may take a moment on first load</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.28.2/full/pyodide.js"></script>
    <!-- Monaco Editor -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
    <script>
        // Configure Monaco Editor
        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' }});
        
        require(['vs/editor/editor.main'], function () {
            // Set up Monaco Editor theme
            monaco.editor.setTheme('vs-dark');
            
            // Make Monaco available globally
            window.MonacoEditor = monaco.editor;
            window.MonacoLanguages = monaco.languages;
            
            console.log('Monaco Editor loaded successfully');
            
            // Trigger editor initialization when Monaco is ready
            if (window.initializeEditors) {
                window.initializeEditors();
            }
        });
    </script>
    <script src="js/examples.js"></script>
    <script src="js/ttp-processor.js"></script>
    <script>
        // Debug: Check if examples loaded
        console.log('After examples.js load, window.TTP_EXAMPLES:', window.TTP_EXAMPLES);
    </script>
    <script src="js/app-monaco.js"></script>
    
        <!-- Hidden file input for import -->
        <input type="file" id="importFile" style="display: none;">

        <!-- Save Workspace Modal -->
        <div id="saveWorkspaceModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üíæ Save Workspace</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Enter a name for your workspace:</p>
                    <input type="text" id="workspaceNameInput" placeholder="Enter workspace name..." autofocus>
                    <div class="modal-actions">
                        <button id="saveWorkspaceConfirm" class="btn btn-primary">Save</button>
                        <button id="saveWorkspaceCancel" class="btn btn-secondary">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Load Workspace Modal -->
        <div id="loadWorkspaceModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üìÇ Load Workspace</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Select a workspace to load:</p>
                    <div id="workspaceList" class="workspace-list">
                        <!-- Workspaces will be populated here -->
                    </div>
                    <div class="modal-actions">
                        <button id="loadWorkspaceConfirm" class="btn btn-primary" disabled>Load</button>
                        <button id="loadWorkspaceCancel" class="btn btn-secondary">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manage Workspaces Modal -->
        <div id="manageWorkspacesModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üîß Manage Workspaces</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Manage your saved workspaces:</p>
                    <div id="manageWorkspaceList" class="workspace-list">
                        <!-- Workspaces will be populated here -->
                    </div>
                    <div class="modal-actions">
                        <button id="manageWorkspaceDelete" class="btn btn-danger" disabled>Delete Selected</button>
                        <button id="manageWorkspaceCancel" class="btn btn-secondary">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inputs Configuration Modal -->
        <div id="inputsModal" class="modal">
            <div class="modal-content large-modal">
                <div class="modal-header">
                    <h3>üì• Inputs Configuration</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Configure multiple named inputs for your TTP templates. Each input can be associated with specific templates and groups.</p>
                    
                    <div class="inputs-container">
                        <div class="inputs-header">
                            <h4>Inputs</h4>
                            <button id="addInputBtn" class="btn btn-primary">+ Add Input</button>
                        </div>
                        
                        <div id="inputsList" class="inputs-list">
                            <!-- Inputs will be populated here -->
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button id="saveInputsBtn" class="btn btn-primary">Save Inputs</button>
                        <button id="clearInputsBtn" class="btn btn-secondary">Clear All</button>
                        <button id="cancelInputsBtn" class="btn btn-secondary">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Packages Configuration Modal -->
        <div id="packagesModal" class="modal">
            <div class="modal-content large-modal">
                <div class="modal-header">
                    <h3>üì¶ Pyodide Packages</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Install additional Python packages to extend TTP functionality. Packages are loaded from PyPI or custom URLs.</p>
                    
                    <div class="packages-container">
                        <div class="packages-header">
                            <h4>Installed Packages</h4>
                            <button id="addPackageBtn" class="btn btn-primary">+ Add Package</button>
                        </div>
                        
                        <div id="packagesList" class="packages-list">
                            <!-- Packages will be populated here -->
                        </div>
                        
                        <div class="packages-info">
                            <h5>Package Requirements & Sources</h5>
                            <div class="packages-requirements">
                                <h6>‚ö†Ô∏è Important Requirements:</h6>
                                <ul>
                                    <li><strong>Pure Python Only:</strong> Packages must be pure Python (no C extensions)</li>
                                    <li><strong>Wheel Files:</strong> Must be <code>-none-any.whl</code> format for PyPI packages</li>
                                    <li><strong>Pyodide Compatible:</strong> Packages with C extensions need special Pyodide builds</li>
                                </ul>
                            </div>
                            <div class="packages-sources">
                                <h6>Package Sources:</h6>
                                <ul>
                                    <li><strong>PyPI:</strong> Enter package name (e.g., <code>requests</code>, <code>pyyaml</code>)</li>
                                    <li><strong>URL:</strong> Enter full URL to wheel file (e.g., <code>https://example.com/package.whl</code>)</li>
                                    <li><strong>Note:</strong> Packages are loaded when processing starts and cached in browser</li>
                                </ul>
                            </div>
                            <div class="packages-examples">
                                <h6>‚úÖ Compatible Examples:</h6>
                                <ul>
                                    <li><code>requests</code> - HTTP library</li>
                                    <li><code>pyyaml</code> - YAML parser</li>
                                    <li><code>jsonschema</code> - JSON validation</li>
                                    <li><code>python-dateutil</code> - Date utilities</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="packages-status">
                        <div class="packages-status-info">
                            <h6>üìã Package Status</h6>
                            <p>Packages are <strong>configured</strong> when you add them here. They will be <strong>installed</strong> automatically when you process a template.</p>
                            <div class="packages-status-steps">
                                <div class="step">1Ô∏è‚É£ Add package name/URL</div>
                                <div class="step">2Ô∏è‚É£ Click "Save Packages"</div>
                                <div class="step">3Ô∏è‚É£ Process a template to install packages</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button id="savePackagesBtn" class="btn btn-primary">üíæ Save Packages</button>
                        <button id="clearPackagesBtn" class="btn btn-secondary">üóëÔ∏è Clear All</button>
                        <button id="cancelPackagesBtn" class="btn btn-secondary">‚ùå Cancel</button>
                    </div>
                </div>
            </div>
        </div>
</body>
</html>
